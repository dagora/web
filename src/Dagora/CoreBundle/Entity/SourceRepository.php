<?php

namespace Dagora\CoreBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\AbstractQuery;

/**
 * SourceRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SourceRepository extends EntityRepository
{
    /**
     * Return a source
     *
     * @param array $params
     *      - int $id
     *
     * @return Source
     */
    public function findOneBy(array $params)
    {
        return $this->_em->createQuery('SELECT s
            FROM Dagora\CoreBundle\Entity\Source s
            WHERE s.id = :id')
            ->setParameter('id', $params['id'])
            ->getOneOrNullResult(AbstractQuery::HYDRATE_OBJECT);
    }

    /**
     * Count the number of total results
     *
     * @param array $params
     * @return int
     */
    public function count($params) {

        $commonData = $this->setFindAllByCommonConditions($params);

        // no results
        if ( $commonData == -1 ) return array();

        $conditions = $commonData['conditions'];
        $values     = $commonData['values'];

        // get count
        $extraSql = count($conditions) ? 'WHERE ' .  join(' AND ', $conditions) : '';
        return $this->_em->createQuery('SELECT count(s) FROM Dagora\CoreBundle\Entity\Source s ' . $extraSql)
                ->setParameters($values)
                ->getSingleScalarResult();
    }

    /**
     * Return sources
     *
     * @param array $params
     * @return Sources[]
     */
    public function findAllBy($params)
    {
        // set start and limit
        if ( !isset($params['start']) ) $params['start'] = 0;
        if ( !isset($params['num']) ) $params['num'] = 20;

        $commonData = $this->setFindAllByCommonConditions($params);

        // no results
        if ( $commonData == -1 ) return array();

        $conditions = $commonData['conditions'];
        $values     = $commonData['values'];

        // set order
        $extraSelect = '';
        $order = '';

        if ( isset($params['order']) ) {

            if ( 'title' == $params['order'] ) {
                $order = 'ORDER BY s.title asc';
            }
            else if ( 'ids' == $params['order'] ) {

                $extraSelect = ', FIELD(s.id, '.join(',', $values['ids']).')  as HIDDEN field';
                $order = 'ORDER BY field';
            }
        }

        // get results
        $extraSql = count($conditions) ? 'WHERE ' .  join(' AND ', $conditions) : '';

        $q = $this->_em
            ->createQuery('SELECT p, ptr '.$extraSelect.'
                FROM Dagora\CoreBundle\Entity\Source s '
                . $extraSql . ' '
                . $order)
            ->setParameters($values);

        // we have already made the limit on the previous query
        if ( !isset($values['ids']) ) {
            $q->setFirstResult($params['start'])
              ->setMaxResults($params['num']);
        }

        return $q->setHint(\Doctrine\ORM\Query::HINT_INCLUDE_META_COLUMNS, TRUE)
                 ->getResult(AbstractQuery::HYDRATE_OBJECT);
    }

    /**
     * Private function that sets the common conditions
     *
     * @param array $params
     * @return array
     */
    private function setFindAllByCommonConditions($params)
    {
        $conditions = $values = array();

        // get with ids
        if ( isset($params['id']) ) {
            $conditions[]  = "s.id IN (:ids)";
            $values['ids'] = $params['id'];
        }

        return array('conditions' => $conditions, 'values' => $values);
    }

}